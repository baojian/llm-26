<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{ font-family: system-ui; margin:0; padding:14px; background:#fff; }
    .grid{ display:grid; grid-template-columns: 44% 56%; gap:14px; align-items:stretch; }
    .card{
      border:2px solid rgba(0,0,0,0.10);
      border-radius:16px;
      background:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,0.08);
      padding:12px 12px;
    }
    .title{ font-weight:900; color:#1f4e9a; font-size:20px; margin-bottom:8px; }
    textarea{
      width:100%;
      height:130px;
      background:#f0f0f0;
      border:1px solid #cfcfcf;
      border-radius:12px;
      font-size:18px;
      line-height:1.35;
      padding:10px;
      box-sizing:border-box;
      resize: vertical;
    }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    label{ font-weight:800; opacity:.85; }
    input{
      width:90px;
      font-size:16px;
      font-weight:800;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.18);
    }
    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.15);
      background:#1f4e9a;
      color:#fff;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      background:#f6f6f6;
      border-radius:12px;
      padding:10px 10px;
      border:1px solid rgba(0,0,0,0.10);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .kv{ display:flex; gap:8px; align-items:baseline; }
    .kv b{ width:88px; display:inline-block; }
    .runtime{ font-size:16px; font-weight:900; color:#d00; }
    .imgbox{
      height: 450px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: #fafafa;
      border-radius:14px;
      border:1px dashed rgba(0,0,0,0.18);
      overflow:hidden;
      position:relative;
    }
    .imgbox img{ max-width:100%; max-height:100%; display:none; }
    .placeholder{ font-size:18px; opacity:.7; text-align:center; padding:0 12px; }
    .dl{
      position:absolute; right:12px; bottom:12px;
      display:none;
      background:rgba(255,255,255,0.92);
      border:1px solid rgba(0,0,0,0.12);
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      font-size:14px;
    }
    .dl a{ color:#1f4e9a; text-decoration:none; }
    .hint{ margin-top:10px; font-size:16px; opacity:.8; }
    /* Make ONLY the Runtime card smaller */
    .runtime-card{
    padding: 8px 10px;   /* smaller inner padding */
    }

    .runtime-card .title{
    font-size: 16px;
    margin-bottom: 4px;
    }

    .runtime-mono{
    padding: 8px 10px;   /* smaller mono padding */
    font-size: 13px;     /* smaller text */
    height: 200px;
    line-height: 1.25;
    min-height: 0;       /* remove the default min-height if any */
    }
  </style>
</head>
<body>

<div class="grid">
  <!-- LEFT column -->
  <div>
    <!-- Prompt (upper left) -->
    <div class="card">
      <div class="title">Prompt</div>
      <textarea id="prompt">a watercolor painting of a university campus gate at sunset, people fully clothed, family-friendly</textarea>

      <div class="controls">
        <button id="go">Generate</button>
        <div class="row">
          <div class="kv"><label>Steps</label><input id="steps" type="number" value="30" min="5" max="80"></div>
          <div class="kv"><label>Guidance</label><input id="gs" type="number" value="7.5" step="0.1" min="1" max="20"></div>
          <div class="kv"><label>Seed</label><input id="seed" type="number" placeholder="(opt)"></div>
        </div>
      </div>
    </div>

    <div style="height:10px;"></div>

    <!-- Preprocessing/details (middle left) -->
    <div class="card">
      <div class="title">Preprocessing / Settings</div>
      <div id="meta" class="mono">Waiting…</div>
    </div>

    <div style="height:10px;"></div>

    <!-- Runtime (lower left) -->
    <div class="card runtime-card">
        <div class="title">Runtime</div>
        <div class="mono runtime-mono">
            <div><span class="runtime">Total time:</span> <span id="rt">—</span></div>
            <div style="height:4px;"></div>
            <div><b>Status:</b> <span id="status">Idle</span></div>
        </div>
    </div>
  </div>

  <!-- RIGHT column: Image -->
  <div class="card">
    <div class="title">Generated Image</div>
    <div class="imgbox" >
      <div id="ph" class="placeholder">
        Click <b>Generate</b> → image will appear here.<br/>
        (Requires local server: <span style="color:#1f4e9a; font-weight:900;">127.0.0.1:5055</span>)
      </div>
      <img id="img" alt="generated" />
      <div class="dl" id="dl"><a id="dlA" href="#" download="out.png">Download PNG</a></div>
    </div>

    <div class="hint">
      Tip: first run may be slow because model weights are downloaded into your .cache.<br/>
      <div style="height:10px;"></div>
      Setup: <b>pip install diffusers</b>, then run <b>uvicorn sd_server:app --host 127.0.0.1 --port 5055</b>.
    Open slides via a local server: <b>python3 -m http.server 8000</b>.
    </div>
  </div>
</div>

<script>
  const API = "http://127.0.0.1:5055";

  const btn = document.getElementById("go");
  const meta = document.getElementById("meta");
  const rt = document.getElementById("rt");
  const status = document.getElementById("status");
  const img = document.getElementById("img");
  const ph = document.getElementById("ph");
  const dl = document.getElementById("dl");
  const dlA = document.getElementById("dlA");

  async function refreshHealth(){
    try{
      const r = await fetch(`${API}/health`);
      const j = await r.json();
      meta.textContent =
`MODEL:   ${j.model}
DEVICE:  ${j.device}
DTYPE:   (server decides)
NOTE:    attention_slicing = enabled
SAFETY:  disabled (lecture demo)`;
    }catch(e){
      meta.textContent =
`Cannot reach ${API}
Start the server:
  uvicorn sd_server:app --host 127.0.0.1 --port 5055`;
    }
  }

  refreshHealth();

  btn.onclick = async () => {
    btn.disabled = true;
    status.textContent = "Generating…";
    rt.textContent = "…";
    dl.style.display = "none";
    img.style.display = "none";
    ph.style.display = "block";

    const prompt = document.getElementById("prompt").value.trim();
    const steps = parseInt(document.getElementById("steps").value || "30", 10);
    const gs = parseFloat(document.getElementById("gs").value || "7.5");
    const seedVal = document.getElementById("seed").value.trim();
    const seed = seedVal === "" ? null : parseInt(seedVal, 10);

    const t0 = performance.now();

    try{
      const r = await fetch(`${API}/generate`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          prompt,
          num_inference_steps: steps,
          guidance_scale: gs,
          seed
        })
      });

      if(!r.ok){
        status.textContent = `HTTP ${r.status}`;
        const txt = await r.text();
        meta.textContent = txt;
        return;
      }

      const j = await r.json();
      const t1 = performance.now();
      rt.textContent = `${((t1 - t0)/1000).toFixed(2)} s (server: ${j.seconds}s)`;
      status.textContent = `Done (device: ${j.device})`;

      const dataUrl = `data:image/png;base64,${j.image_base64}`;
      img.src = dataUrl;
      img.style.display = "block";
      ph.style.display = "none";

      dlA.href = dataUrl;
      dl.style.display = "block";
    }catch(e){
      status.textContent = "Error";
      meta.textContent = String(e);
    }finally{
      btn.disabled = false;
    }
  };
</script>

</body>
</html>